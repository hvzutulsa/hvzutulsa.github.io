<html>
	<head>
		<link type="text/css" rel="stylesheet" href="../css/bootstrap/css/bootstrap.min.css"/>
		<link type="text/css" rel="stylesheet" href="../css/font-awesome/css/font-awesome.min.css"/>
		<link type="text/css" rel="stylesheet" href="../css/login_stylesheet.css"/>
		<title>Humans vs Zombies - Utulsa</title>
		<script type="text/javascript" src='https://cdn.firebase.com/js/client/1.0.11/firebase.js'></script>
        <script type="text/javascript" src='https://cdn.firebase.com/js/simple-login/1.3.2/firebase-simple-login.js'></script>
        <script type="text/javascript">
            var firebaseRef = new Firebase("https://hvz-utulsa.firebaseio.com/");
            var auth = new FirebaseSimpleLogin(firebaseRef, function(error, user) {
            	if (error) {
            		// an error occurred when the user attempted to login
                    if (typeof(localStorage) != undefined) {
                        localStorage.clear();
                    }
				} else if (user) {
				    // user authenticated with Firebase
                    console.log(user);
                    saveUserCredentials(user);
                    if (userRegistered(localStorage.id)) {
                    	redirect();
                    } else {
                    	registerUser(user, user.thirdPartyUserData, localStorage.id);
                    }
				}
            });

            function facebookLogin() {
            	auth.login('facebook', {
            		scope: "basic_info, email"
            	});
            }

            function githubLogin() {
            	auth.login('github', {
            		scope: "user"
            	});
            }

            function googleLogin() {
            	auth.login('google', {
            		scope: "https://www.googleapis.com/auth/plus.login, profile, email"
            	});
            }
            
            function localLogin() {
            	auth.login('password', {
                	email: document.getElementById("userEmail").value,
                	password: document.getElementById("userPassword").value
                });
            }

			function redirect() {
				window.location = "../home/home.html";
			}           

            function registerUser(user, userData, userId) {
            	var userRef = new Firebase("https://hvz-utulsa.firebaseio.com/users/" + userId);
                var userInfo = {
                    name: {
                        first: "",
                        middle: "",
                        last: ""
                    },
                    displayName: "",
                    picture: "",
                    phone: "",
                    email: ""
                };
                if (user.provider == 'facebook') {
                	userInfo.name.first = userData.first_name;
                	userInfo.name.last = userData.last_name;
                	if (user.displayName != "") {
                		userInfo.displayName = user.displayName;
                	} else if (userData.name != "") {
                		userInfo.displayName = userData.name;
                	} else {
                		userInfo.displayName = userData.email;
                	}
                	userInfo.email = userData.email;
                } else if (user.provider == 'github') {
                	userInfo.name.first = userData.displayName.split(" ")[0];
                	userInfo.name.last = userData.displayName.indexOf(" ") > 0 ? userData.displayName.split(" ")[1] : "" ;
                	if (userData.displayName != "") {
                		userInfo.displayName = userData.displayName;
                	} else if (user.username != "") {
                		userInfo.displayName = userInfo;
                	} else {
                		userInfo.displayName = userData.emails[0].email;
                	}
                	userInfo.picture = userData.avatar_url;
                	userInfo.email = userData.emails[0].email;
                } else if (user.provider == 'google') {
                	userInfo.name.first = userData.given_name;
                	userInfo.name.last = userData.family_name;
                	if (user.displayName != "") {
                		userInfo.displayName = user.displayName;
                	} else if (userData.name != "") {
                		userInfo.displayName = userData.name;
                	} else {
                		userInfo.displayName = user.email;
                	}
                	userInfo.picture = userData.picture;
                	userInfo.email = user.email;
                } else if (user.provider == 'twitter') {
                	userInfo.name.first = user.displayName.split(" ")[0];
                	userInfo.name.last = user.displayName.split(" ")[1] != "undefined" ? user.displayName.split(" ")[1] : "" ;
                	if (user.displayName != "") {
                		userInfo.displayName = user.displayName;
                	} else if (user.username != "") {
                		userInfo.displayName = user.username;
                	} else {
                		userInfo.displayName = "(John | Jane) Doe";
                	}
                }
                userRef.set(userInfo);
                redirect();
            }

            function saveUserCredentials(user) {
            	if (typeof(localStorage) != undefined) {
            		if (user.provider == 'password') {
                    	localStorage.id = user.email.replace(".", "-");
                    } else if (user.provider == 'facebook') {
                    	localStorage.id = user.thirdPartyUserData.email.replace(".", "-");
                    } else if (user.provider == 'github') {
                    	localStorage.id = user.thirdPartyUserData.emails[0].email.replace(".", "-");
                    } else if (user.provider == 'google') {
                    	localStorage.id = user.email.replace(".", "-");
                    } else if (user.provider == 'twitter') {
                    	localStorage.id = user.username;
                    }
                }
            }

            function twitterLogin() {
            	auth.login('twitter');
            }

            function userRegistered(userId) {
            	var usersRef = new Firebase("https://hvz-utulsa.firebaseio.com/users");
            	var exists = false;
            	usersRef.child(userId).once('value', function(state) {
            		exists = state.val() !== null;
            	});
            	return exists;
            }
        </script>
	</head>

	<body>
		<div id="loginPanel" class="panel-body">
			<div class="text-center">
				<h1>Login</h1>
			</div>
			<form role="form">
				<div class="form-group">
					<input id="userEmail" type="email" class="form-control" placeholder="Email Address">
				</div>
				<div class="form-group">
					<input id="userPassword" type="password" class="form-control" placeholder="Password">
				</div>
				<div class="text-center">
					<button type="button" class="btn btn-primary" onclick="localLogin()">Login</button>
					<a href="../register/register.html" class="btn btn-primary">Register</a>
				</div>
			</form>
			<div class="panel-body">
				<div class="text-center">
					<button onclick="facebookLogin()" class="btn btn-primary"><span class="fa fa-facebook"></span> Facebook</button>
					<button onclick="githubLogin()" class="btn btn-success"><span class="fa fa-github"></span> Github</button>
					<button onclick="googleLogin()" class="btn btn-danger"><span class="fa fa-google-plus"></span> Google</button>
					<button onclick="twitterLogin()" class="btn btn-info"><span class="fa fa-twitter"></span> Twitter</button>
				</div>
			</div>
		</div>
	</body>
</html>