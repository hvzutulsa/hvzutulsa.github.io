<html>
    <head>
        <link type="text/css" rel="stylesheet" href="../css/bootstrap/css/bootstrap.min.css"/>
        <link type="text/css" rel="stylesheet" href="../css/profile_stylesheet.css"/>
        <title>Humans vs Zombies - Utulsa</title>
        <script type="text/javascript" src='https://cdn.firebase.com/js/client/1.0.11/firebase.js'></script>
        <script type="text/javascript" src='https://cdn.firebase.com/js/simple-login/1.3.2/firebase-simple-login.js'></script>
        <script type="text/javascript">
            var firebaseRef = new Firebase("https://hvz-utulsa.firebaseio.com/");
            var auth = new FirebaseSimpleLogin(firebaseRef, function(error, user) {
                if (error) {
                    // an error occurred when the user attempted to login
                    if (typeof(localStorage) != undefined) {
                        localStorage.id = undefined;
                    }
                }
            });

            function emailActive() {
                document.getElementById("profileTab").className = "hide";
                document.getElementById("profileElement").className = "";
                document.getElementById("passwordTab").className = "hide";
                document.getElementById("passwordElement").className = "";
                document.getElementById("emailTab").className = "";
                document.getElementById("emailElement").className = "active";
            }
            
            function logout() {
                if (typeof(localStorage) != undefined) {
                    localStorage.id = undefined;
                }
                auth.logout();
                redirect();
            }

            function passwordActive() {
                document.getElementById("profileTab").className = "hide";
                document.getElementById("profileElement").className = "";
                document.getElementById("emailTab").className = "hide";
                document.getElementById("emailElement").className = "";
                document.getElementById("passwordTab").className = "";
                document.getElementById("passwordElement").className = "active";
            }

            function profileActive() {
                document.getElementById("emailTab").className = "hide";
                document.getElementById("emailElement").className = "";
                document.getElementById("passwordTab").className = "hide";
                document.getElementById("passwordElement").className = "";
                document.getElementById("profileTab").className = "";
                document.getElementById("profileElement").className = "active";
            }
            
            function redirect() {
                window.location = "../home/home.html";
            }
            
            function validateForm() {
                var userId = localStorage.id;
                var userRef = new Firebase("https://hvz-utulsa.firebaseio.com/users/" + userId);
                userRef.once('value', function(state) {
                    var valid = true;

                    var displayName = document.getElementById("displayName");
                    if (state.val().displayName != displayName.value) {
                        if (displayName.value == '') {
                            document.getElementById("displayNameDiv").className += " " + "has-error";
                            firstName.className += " " + "error";
                            valid = false;
                        } else {
                            userRef.update({displayName: displayName.value});
                        }
                    }

                    var firstName = document.getElementById("firstName");
                    if (state.val().name.first != firstName.value) {
                        if (firstName.value == '') {
                            document.getElementById("firstNameDiv").className += " " + "has-error";
                            firstName.className += " " + "error";
                            valid = false;
                        } else {
                            userRef.child("name").update({first: firstName.value});
                        }
                    }

                    var middleInitial = document.getElementById("mi");
                    if (state.val().name.middle != middleInitial.value) {
                        userRef.child("name").update({middle: middleInitial.value});
                    }

                    var lastName = document.getElementById("lastName");
                    if (state.val().name.last != lastName.value) {
                        if (lastName.value == '') {
                            document.getElementById("lastNameDiv").className += " " + "has-error";
                            lastName.className += " " + "error";
                            valid = false;
                        } else {
                            userRef.child("name").update({last: lastName.value});
                        }
                    }

                    var phoneNumber = document.getElementById("phoneNumber");
                    if (state.val().phone != phoneNumber.value) {
                        if (phoneNumber.value != '' && !(phoneNumber.value.match(/\d{10}$|\d{3}-\d{3}-\d{4}$|\(\d{3}\) \d{3}\d{4}$|\(\d{3}\) \d{3}-\d{4}$/))) {
                            document.getElementById("phoneNumberDiv").className += " " + "has-error";
                            phoneNumber.className += " " + "error";
                            valid = false;
                        } else {
                            userRef.update({phone: phoneNumber.value});
                        }
                    }

                    var inputEmail = document.getElementById("inputEmail");
                    if (state.val().email !== inputEmail.value) {
                        if (inputEmail.value == '' || inputEmail.value.indexOf('@') < 1 || inputEmail.value.indexOf('.') < 3) {
                            document.getElementById("inputEmailDiv").className += " " + "has-error";
                            inputEmail.className += " " + "error";
                            valid = false;
                        }

                        var confirmEmail = document.getElementById("confirmEmail");
                        if (confirmEmail.value == '' || inputEmail.value != confirmEmail.value) {
                            document.getElementById("inputEmailDiv").className += " " + "has-error";
                            inputEmail.className += " " + "error";
                            document.getElementById("confirmEmailDiv").className += " " + "has-error";
                            confirmEmail.className += " " + "error";
                            valid = false;
                        } else {
                            userRef.update({email: inputEmail.value});
                        }
                    } else {
                        var confirmEmail = document.getElementById("confirmEmail");
                        if (confirmEmail.value != '' || inputEmail.value != confirmEmail.value) {
                            document.getElementById("confirmEmailDiv").className += " " + "has-error";
                            confirmEmail.className += " " + "error";
                            valid = false;
                        }
                    }

                    var oldPassword = document.getElementById("oldPassword");
                    if (oldPassword.value != "") {
                        var newPassword = document.getElementById("newPassword");
                        var confirmPassword = document.getElementById("confirmPassword");
                        if (newPassword.value == "" || newPassword.value != confirmPassword.value) {
                            document.getElementById("newPasswordDiv").className += " " + "has-error";
                            newPassword.className += " " + "error";
                            document.getElementById("confirmPasswordDiv").className += " " + "has-error";
                            confirmPassword.className += " " + "error";
                            valid = false;
                        } else {
                            var firebaseRef = new Firebase("https://hvz-utulsa.firebaseio.com");
                            var auth = new FirebaseSimpleLogin(firebaseRef, function(error, user) {
                                if (user) {
                                    if (user.provider == 'password') {
                                        console.log("provider password");
                                        auth.changePassword(state.val().email, oldPassword.value, newPassword.value, function(error, success) {
                                            if (error) {
                                                console.log(error);
                                                document.getElementById("oldPasswordDiv").className += " " + "has-error";
                                                oldPassword.className += " " + "error";
                                                valid = false;
                                            }
                                        });
                                    } else {
                                        console.log("create user");
                                        auth.createUser(state.val().email, newPassword.value, function(error, user) {
                                            if (error) {
                                                console.log("error");
                                                if (error.code == "EMAIL_TAKEN") {
                                                    auth.changePassword(state.val().email, oldPassword.value, newPassword.value, function(error, success) {
                                                        if (error) {
                                                            console.log("error");
                                                            document.getElementById("oldPasswordDiv").className += " " + "has-error";
                                                            oldPassword.className += " " + "error";
                                                            valid = false;
                                                        }
                                                    });
                                                } else {
                                                    document.getElementById("oldPasswordDiv").className += " " + "has-error";
                                                    oldPassword.className += " " + "error";
                                                    valid = false;
                                                }
                                            }
                                        });
                                    }
                                }
                            });
                        }
                        var newPassword = document.getElementById("newPassword");
                        if (newPassword.value != "") {
                            document.getElementById("newPasswordDiv").className += " " + "has-error";
                            newPassword.className += " " + "error";
                            valid = false;
                        }

                        var confirmPassword = document.getElementById("confirmPassword");
                        if (confirmPassword.value != "") {
                            document.getElementById("confirmPasswordDiv").className += " " + "has-error";
                            confirmPassword.className += " " + "error";
                            valid = false;
                        }
                    }

                    if (valid) {
                        window.location.reload();
                    }
                });
            }
        </script>
    </head>
    
    <body>
        <div id="mainPanel" class="panel panel-default">
            <div class="text-center">
				<h1>Profile</h1>
			</div>
            <div id="playerPanel" class="panel-body">
                <div id="picturePanel" class="panel-body">
                    <form role="form">
                        <div class="form-group">
                            <a href="#"><img id="profilePicture" src="../img/default_profile.jpg"/></a>
                        </div>
                        <div id="displayNameDiv" class="form-group">
                            <input id="displayName" type="text" class="form-control" placeholder="Display Name">
                        </div>
                        <div class="form-group text-center">
                            <button type="button" class="btn btn-primary" onclick="logout()">Logout</button>
                        </div>
                    </form>
                </div>
                <div id="infoPanel" class="panel-body">
                    <ul class="nav nav-tabs tabs">
                        <li class="active"><a onclick="">Status</a></li>
                        <li><a onclick="">Stats</a></li>
                    </ul>
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <label for="currentStatus" class="col-md-4 control-label">Status</label>
                            <div class="col-md-8">
                                <input id="currentStatus" type="text" class="form-control" placeholder="Not playing" disabled>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="currentBiteTag" class="col-md-4 control-label">Bite Tag</label>
                            <div class="col-md-8">
                                <input id="currentBiteTag" type="text" class="form-control" placeholder="None" disabled>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div id="profilePanel" class="panel-body">
                <div class="panel-body">
                    <ul class="nav nav-tabs tabs">
                        <li id="profileElement" class="active"><a onclick="profileActive()">Profile</a></li>
                        <li id="emailElement"><a onclick="emailActive()">Email</a></li>
                        <li id="passwordElement"><a onclick="passwordActive()">Password</a></li>
                    </ul>
                    <div id="profileTab">
                        <form role="form">
                            <form class="form-inline" role="form">
                                <div id="firstNameDiv" class="form-group col-md-5">
                                    <input id="firstName" type="text" class="form-control" placeholder="First Name">
                                </div>
                                <div class="form-group col-md-2">
                                    <input id="mi" type="text" class="form-control" placeholder="MI">
                                </div>
                                <div id="lastNameDiv" class="form-group col-md-5">
                                    <input id="lastName" type="text" class="form-control" placeholder="Last Name">
                                </div>
                            </form>
                            <div id="phoneNumberDiv" class="form-group col-md-12">
                                <input id="phoneNumber" type="text" class="form-control bfh-phone" placeholder="Phone Number">
                            </div>
                        </form>
                    </div>
                    <div id="emailTab" class="hide">
                        <form role="form">
                            <div id="inputEmailDiv" class="form-group col-md-12">
                                <input id="inputEmail" type="email" class="form-control" placeholder="Email Address">
                            </div>
                            <div id="confirmEmailDiv" class="form-group col-md-12">
                                <input id="confirmEmail" type="email" class="form-control" placeholder="Confirm Email Address to Change">
                            </div>
                        </form>
                    </div>
                    <div id="passwordTab" class="hide">
                        <form role="form">
                            <div id="oldPasswordDiv" class="form-group col-md-12">
                                <input id="oldPassword" type="password" class="form-control" placeholder="Current Password or none if not sure">
                            </div>
                            <div id="newPasswordDiv" class="form-group col-md-12">
                                <input id="newPassword" type="password" class="form-control" placeholder="New Password">
                            </div>
                            <div id="confirmPasswordDiv" class="form-group col-md-12">
                                <input id="confirmPassword" type="password" class="form-control" placeholder="Confirm New Password">
                            </div>
                        </form>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-primary" onclick="redirect()">Home</button>
                    </div>
                    <div class="col-md-4 text-center">
                        <button type="button" class="btn btn-primary" onclick="validateForm()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            if (typeof(localStorage) != undefined) {
                userId = localStorage.id;
                var userRef = new Firebase("https://hvz-utulsa.firebaseio.com/users/" + userId);
                userRef.once('value', function(state) {
                    if (state.val().picture != "") {
                        document.getElementById("profilePicture").src = state.val().picture;
                    }
                    if (state.val().displayName != "") {
                        document.getElementById("displayName").value = state.val().displayName;
                    }
                    if (state.val().name.first != "") {
                        document.getElementById("firstName").value = state.val().name.first;
                    }
                    if (state.val().name.middle != "") {
                        document.getElementById("mi").value = state.val().name.middle;
                    }
                    if (state.val().name.last != "") {
                        document.getElementById("lastName").value = state.val().name.last;
                    }
                    if (state.val().phone != "") {
                        document.getElementById("phoneNumber").value = state.val().phone;
                    }
                    if (state.val().email != "") {
                        document.getElementById("inputEmail").value = state.val().email;
                    }
                });
            }
        </script>
    </body>
</html>